<!-- File: c:\taxi\taxilocal-enhanced.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taxi Local - Enhanced with Google Calendar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            width: 100%;
            max-width: 100%;
            flex: 1;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            min-height: 0;
        }
        
        .panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            min-height: 0;
        }
        
        .sync-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .sync-status.success { background: #d4edda; color: #155724; }
        .sync-status.warning { background: #fff3cd; color: #856404; }
        .sync-status.info { background: #cce7ff; color: #004085; }
        .sync-status.error { background: #f8d7da; color: #721c24; }
        
        .calendar-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .btn-calendar {
            background: #4285f4;
            color: white;
            padding: 6px 12px;
            width: auto;
            font-size: 0.8em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-calendar:hover {
            background: #3367d6;
        }
        
        .btn-calendar:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .calendar-status {
            font-size: 0.8em;
            padding: 5px;
            border-radius: 3px;
            margin-bottom: 10px;
        }
        
        .calendar-connected {
            background: #d4edda;
            color: #155724;
        }
        
        .calendar-disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* ... existing styles ... */
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, textarea, button, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        button {
            background: #007bff;
            color: white;
            cursor: pointer;
            border: none;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .booking-item {
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            background: #f9f9f9;
            position: relative;
        }
        
        .booking-item.completed {
            opacity: 0.8;
            background: #e8f5e8;
            border-color: #28a744;
        }
        
        .booking-item.pob {
            background: #fff3cd;
            border-color: #ffc107;
        }
        
        .booking-item.en-route {
            background: #d1ecf1;
            border-color: #17a2b8;
        }
        
        .booking-item.waiting {
            background: #f8d7da;
            border-color: #dc3545;
        }
        
        .booking-item.current-time {
            border: 3px solid #ff6b35;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 53, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 53, 0); }
        }
        
        .booking-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        
        .booking-details {
            font-size: 0.9em;
            color: #666;
        }
        
        .booking-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .btn-small {
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85em;
            width: auto;
            flex: 1;
            min-width: 80px;
        }
        
        .btn-active { background: #007bff; color: white; }
        .btn-en-route { background: #17a2b8; color: white; }
        .btn-waiting { background: #dc3545; color: white; }
        .btn-pob { background: #ffc107; color: black; }
        .btn-complete { background: #28a745; color: white; }
        .btn-delete { background: #6c757d; color: white; }
        .btn-edit { background: #fd7e14; color: white; }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .stat {
            padding: 10px;
        }
        
        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            font-size: 0.8em;
            color: #666;
        }
        
        .filter-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            width: auto;
        }
        
        .filter-btn.active {
            background: #007bff;
            color: white;
        }
        
        .time-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn-time {
            background: #17a2b8;
            color: white;
            padding: 6px 12px;
            width: auto;
            font-size: 0.8em;
        }
        
        .file-controls {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn-file {
            background: #6c757d;
            color: white;
            padding: 6px 12px;
            width: auto;
            font-size: 0.8em;
        }
        
        .btn-clear-form {
            background: #28a745;
            color: white;
            padding: 6px 12px;
            width: auto;
            font-size: 0.8em;
        }
        
        .stop-item {
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }
        
        .recurring-options {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .day-selector {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .day-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: #e9ecef;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .day-checkbox.selected {
            background: #007bff;
            color: white;
        }
        
        .day-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .completion-form {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        
        .completion-form.show {
            display: block;
        }
        
        .price-input {
            width: 100px;
            display: inline-block;
            margin-right: 10px;
        }
        
        .status-badge {
            position: absolute;
            right: 10px;
            top: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-active { background: #007bff; color: white; }
        .status-en-route { background: #17a2b8; color: white; }
        .status-waiting { background: #dc3545; color: white; }
        .status-pob { background: #ffc107; color: black; }
        .status-completed { background: #28a745; color: white; }
        
        .timeline {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 3px;
        }
        
        .timeline-item {
            margin-bottom: 2px;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                height: auto;
                gap: 15px;
            }
            
            .panel {
                height: auto;
                min-height: 300px;
                padding: 15px;
            }
            
            body {
                overflow: auto;
                padding: 10px;
            }
            
            .stats {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .stat {
                flex: 1;
                min-width: 120px;
            }
            
            .booking-actions {
                justify-content: center;
            }
            
            .btn-small {
                min-width: 70px;
                font-size: 0.75em;
            }
            
            .filter-controls, .time-controls {
                justify-content: center;
            }
            
            .day-selector {
                justify-content: center;
            }
            
            input, textarea, button, select {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel - New Booking (1/3 width) -->
        <div class="panel">
            <h2>New Booking</h2>
            
            <div id="sync-status" class="sync-status info">
                Working offline - data saved locally
            </div>
            
            <!-- Google Calendar Controls -->
            <div class="calendar-controls">
                <button class="btn-calendar" id="calendar-connect" onclick="connectToGoogleCalendar()">
                    📅 Connect Calendar
                </button>
                <button class="btn-calendar" id="calendar-sync" onclick="syncWithCalendar()" disabled>
                    🔄 Sync Now
                </button>
                <button class="btn-calendar" id="calendar-disconnect" onclick="disconnectCalendar()" disabled>
                    ❌ Disconnect
                </button>
            </div>
            
            <div id="calendar-status" class="calendar-status calendar-disconnected">
                📅 Calendar: Not connected
            </div>
            
            <div class="file-controls">
                <button class="btn-file" onclick="exportData()">📥 Export</button>
                <button class="btn-file" onclick="importData()">📤 Import</button>
                <button class="btn-clear-form" onclick="clearForm()">🧹 Clear Form</button>
                <button class="btn-file" onclick="showKeyboardShortcuts()">⌨️ Shortcuts</button>
                <button class="btn-file" onclick="testReminder()" title="Test reminder system">🔔 Test</button>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="handleFileImport(event)">
            </div>
            
            <div class="stats">
                <div class="stat">
                    <div class="stat-number" id="total-bookings">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="active-bookings">0</div>
                    <div class="stat-label">Active</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="completed-today">0</div>
                    <div class="stat-label">Done</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="today-earnings">£0</div>
                    <div class="stat-label">Earned</div>
                </div>
            </div>
            
            <form id="booking-form">
                <div class="form-group">
                    <label for="customer-name">Customer Name:</label>
                    <input type="text" id="customer-name" required>
                </div>

                <div class="form-group">
                    <label for="customer-phone">Phone:</label>
                    <input type="tel" id="customer-phone" required pattern="[0-9\s\-\+\(\)]{10,15}" title="Please enter a valid phone number (10-15 digits)">
                </div>

                <div class="form-group">
                    <label for="pickup-address">Pickup Address:</label>
                    <input type="text" id="pickup-address" required>
                </div>

                <div class="form-group">
                    <label>Additional Stops:</label>
                    <div id="stops-container"></div>
                    <button type="button" onclick="addStop()" class="btn-small" style="background: #28a745; width: auto;">+ Add Stop</button>
                </div>

                <div class="form-group">
                    <label for="destination-address">Final Destination:</label>
                    <input type="text" id="destination-address" required>
                </div>

                <div class="form-group">
                    <label for="booking-date">Date:</label>
                    <input type="date" id="booking-date" required>
                </div>

                <div class="form-group">
                    <label for="booking-time">Time:</label>
                    <input type="time" id="booking-time" required>
                </div>

                <div class="form-group">
                    <label for="reminder-minutes">Reminder (minutes before):</label>
                    <select id="reminder-minutes">
                        <option value="0">No reminder</option>
                        <option value="5" selected>5 minutes</option>
                        <option value="10">10 minutes</option>
                        <option value="15">15 minutes</option>
                        <option value="30">30 minutes</option>
                        <option value="60">1 hour</option>
                        <option value="120">2 hours</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="notes">Notes:</label>
                    <textarea id="notes" rows="2"></textarea>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="sync-to-calendar" checked>
                        Sync to Google Calendar
                    </label>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="recurring-booking" onchange="toggleRecurring()">
                        Recurring Booking
                    </label>
                    <div id="recurring-options" class="recurring-options" style="display: none;">
                        <div style="margin-bottom: 10px;">
                            <label>Select Days:</label>
                            <div class="day-selector">
                                <div class="day-checkbox" onclick="toggleDay(this, 1)">
                                    <input type="checkbox" value="1"> Mon
                                </div>
                                <div class="day-checkbox" onclick="toggleDay(this, 2)">
                                    <input type="checkbox" value="2"> Tue
                                </div>
                                <div class="day-checkbox" onclick="toggleDay(this, 3)">
                                    <input type="checkbox" value="3"> Wed
                                </div>
                                <div class="day-checkbox" onclick="toggleDay(this, 4)">
                                    <input type="checkbox" value="4"> Thu
                                </div>
                                <div class="day-checkbox" onclick="toggleDay(this, 5)">
                                    <input type="checkbox" value="5"> Fri
                                </div>
                                <div class="day-checkbox" onclick="toggleDay(this, 6)">
                                    <input type="checkbox" value="6"> Sat
                                </div>
                                <div class="day-checkbox" onclick="toggleDay(this, 0)">
                                    <input type="checkbox" value="0"> Sun
                                </div>
                            </div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label for="recurring-end-date">End Date:</label>
                            <input type="date" id="recurring-end-date">
                        </div>
                    </div>
                </div>
                           
                <button type="submit">Create Booking</button>
            </form>
        </div>
        
        <!-- Right Panel - All Bookings (2/3 width) -->
        <div class="panel">
            <h2>All Bookings (<span id="booking-count">0</span>)</h2>
            
            <div class="time-controls">
                <button class="btn-time" onclick="scrollToCurrentTime()">
                    📍 Current Time
                </button>
                <button class="btn-time" onclick="scrollToNextBooking()">
                    ⏭️ Next Job
                </button>
            </div>
            
            <div class="form-group">
                <input type="text" id="booking-search" placeholder="🔍 Search bookings (name, phone, address)..." onkeyup="searchBookings()" style="margin-bottom: 15px;">
            </div>
            
            <div class="filter-controls">
                <button class="filter-btn active" data-filter="active" onclick="setFilter('active')">
                    Active
                </button>
                <button class="filter-btn" data-filter="all" onclick="setFilter('all')">
                    All
                </button>
                <button class="filter-btn" data-filter="completed" onclick="setFilter('completed')">
                    Done
                </button>
                <button class="filter-btn" data-filter="today" onclick="setFilter('today')">
                    Today
                </button>
            </div>
            
            <div id="bookings-list">
                <p>No bookings yet.</p>
            </div>
        </div>
    </div>

    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        let bookings = []; // Array to store all booking data
        let stopCounter = 0; // Counter to keep track of additional stops
        let currentFilter = 'active'; // Current filter for displaying bookings
        let currentSearchTerm = ''; // Current search term for filtering bookings
        let audioContext = null; // Audio context for playing reminder sounds
        let audioInitialized = false; // Flag to check if audio context has been initialized
        
        // Google Calendar API variables
        let gapi = null;
        let google = null;
        let isCalendarConnected = false;
        let accessToken = null;
        let calendarId = 'primary'; // Use primary calendar
        
        // Google API configuration - YOU NEED TO REPLACE THESE WITH YOUR OWN
        const GOOGLE_CLIENT_ID = '';
        const GOOGLE_API_KEY = '';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/calendar';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date and current time in the booking form
            const now = new Date();
            document.getElementById('booking-date').value = now.toISOString().split('T')[0];
            document.getElementById('booking-time').value = now.toTimeString().slice(0, 5);
            
            // Load local data from local storage
            loadLocalData();
            displayBookings(); // Display the current list of bookings
            updateStats(); // Update statistics displayed on the UI
            
            // Setup form submission handler
            document.getElementById('booking-form').addEventListener('submit', handleFormSubmit);
            
            // Update current time indicators every minute
            setInterval(updateCurrentTimeIndicators, 60000);
            
            // Add keyboard shortcuts for user convenience
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            // Request notification permission for reminders
            requestNotificationPermission();
            
            // Start reminder checking system (check every 30 seconds)
            setInterval(checkReminders, 30000);
            
            // Initialize audio on first user interaction
            document.addEventListener('click', initializeAudio, { once: true });
            document.addEventListener('keydown', initializeAudio, { once: true });
            
            // Initialize Google Calendar API
            initializeGoogleCalendar();
        });

        // Google Calendar API Functions
        let googleApiRetryCount = 0;
        const MAX_GOOGLE_API_RETRIES = 5;
        
        async function initializeGoogleCalendar() {
            try {
                // Check if gapi is available
                if (typeof gapi === 'undefined' || !gapi) {
                    if (googleApiRetryCount < MAX_GOOGLE_API_RETRIES) {
                        googleApiRetryCount++;
                        console.log(`Google API not loaded yet, retry ${googleApiRetryCount}/${MAX_GOOGLE_API_RETRIES}...`);
                        setTimeout(() => initializeGoogleCalendar(), 1000);
                        return;
                    } else {
                        console.log('Google API failed to load after maximum retries - working offline only');
                        updateSyncStatus('warning', 'Google Calendar API not available - working offline only');
                        return;
                    }
                }
                
                await new Promise((resolve, reject) => {
                    gapi.load('auth2', {
                        callback: resolve,
                        onerror: reject
                    });
                });
                
                await gapi.auth2.init({
                    client_id: GOOGLE_CLIENT_ID
                });
                
                updateCalendarStatus();
                console.log('Google Calendar API initialized');
            } catch (error) {
                console.error('Error initializing Google Calendar API:', error);
                updateSyncStatus('warning', 'Google Calendar API not available - working offline only');
            }
        }

        async function connectToGoogleCalendar() {
            try {
                // Check if gapi is available
                if (typeof gapi === 'undefined' || !gapi || !gapi.auth2) {
                    updateSyncStatus('error', 'Google Calendar API not available');
                    return;
                }
                
                const authInstance = gapi.auth2.getAuthInstance();
                if (!authInstance) {
                    updateSyncStatus('error', 'Google Calendar API not initialized');
                    return;
                }
                
                const user = await authInstance.signIn({
                    scope: SCOPES
                });
                
                accessToken = user.getAuthResponse().access_token;
                isCalendarConnected = true;
                
                // Load the Calendar API
                await gapi.client.init({
                    apiKey: GOOGLE_API_KEY,
                    discoveryDocs: [DISCOVERY_DOC]
                });
                
                updateCalendarStatus();
                updateSyncStatus('success', 'Connected to Google Calendar successfully');
                
                // Auto-sync existing bookings
                await syncWithCalendar();
                
            } catch (error) {
                console.error('Error connecting to Google Calendar:', error);
                updateSyncStatus('error', 'Failed to connect to Google Calendar');
            }
        }

        async function disconnectCalendar() {
            try {
                const authInstance = gapi.auth2.getAuthInstance();
                await authInstance.signOut();
                
                isCalendarConnected = false;
                accessToken = null;
                
                updateCalendarStatus();
                updateSyncStatus('info', 'Disconnected from Google Calendar');
                
            } catch (error) {
                console.error('Error disconnecting from Google Calendar:', error);
                updateSyncStatus('error', 'Failed to disconnect from Google Calendar');
            }
        }

        function updateCalendarStatus() {
            const statusEl = document.getElementById('calendar-status');
            const connectBtn = document.getElementById('calendar-connect');
            const syncBtn = document.getElementById('calendar-sync');
            const disconnectBtn = document.getElementById('calendar-disconnect');
            
            if (isCalendarConnected) {
                statusEl.textContent = '📅 Calendar: Connected';
                statusEl.className = 'calendar-status calendar-connected';
                connectBtn.disabled = true;
                syncBtn.disabled = false;
                disconnectBtn.disabled = false;
            } else {
                statusEl.textContent = '📅 Calendar: Not connected';
                statusEl.className = 'calendar-status calendar-disconnected';
                connectBtn.disabled = false;
                syncBtn.disabled = true;
                disconnectBtn.disabled = true;
            }
        }

        async function syncWithCalendar() {
            if (!isCalendarConnected) {
                updateSyncStatus('warning', 'Please connect to Google Calendar first');
                return;
            }
            
            try {
                updateSyncStatus('info', 'Syncing with Google Calendar...');
                
                let syncedCount = 0;
                
                for (const booking of bookings) {
                    if (booking.status === 'active' && !booking.calendarEventId) {
                        const eventId = await createCalendarEvent(booking);
                        if (eventId) {
                            booking.calendarEventId = eventId;
                            syncedCount++;
                        }
                    } else if (booking.calendarEventId && booking.status === 'completed') {
                        await updateCalendarEvent(booking);
                    }
                }
                
                saveLocalData();
                updateSyncStatus('success', `Synced ${syncedCount} bookings with Google Calendar`);
                
            } catch (error) {
                console.error('Error syncing with Google Calendar:', error);
                updateSyncStatus('error', 'Failed to sync with Google Calendar');
            }
        }

        async function createCalendarEvent(booking) {
            try {
                const startDateTime = new Date(`${booking.date}T${booking.time}`);
                const endDateTime = new Date(startDateTime.getTime() + (60 * 60 * 1000)); // 1 hour duration
                
                const event = {
                    summary: `Taxi: ${booking.customerName}`,
                    description: `
Customer: ${booking.customerName}
Phone: ${booking.customerPhone}
Pickup: ${booking.pickupAddress}
${booking.stops.length > 0 ? 'Stops: ' + booking.stops.join(', ') + '\n' : ''}Destination: ${booking.destinationAddress}
${booking.notes ? 'Notes: ' + booking.notes : ''}
                    `.trim(),
                    start: {
                        dateTime: startDateTime.toISOString(),
                        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    },
                    end: {
                        dateTime: endDateTime.toISOString(),
                        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    },
                    location: booking.pickupAddress,
                    reminders: {
                        useDefault: false,
                        overrides: booking.reminderMinutes > 0 ? [
                            { method: 'popup', minutes: booking.reminderMinutes }
                        ] : []
                    }
                };
                
                const response = await gapi.client.calendar.events.insert({
                    calendarId: calendarId,
                    resource: event
                });
                
                return response.result.id;
                
            } catch (error) {
                console.error('Error creating calendar event:', error);
                return null;
            }
        }

        async function updateCalendarEvent(booking) {
            if (!booking.calendarEventId) return;
            
            try {
                const startDateTime = new Date(`${booking.date}T${booking.time}`);
                const endDateTime = new Date(startDateTime.getTime() + (60 * 60 * 1000));
                
                let summary = `Taxi: ${booking.customerName}`;
                if (booking.status === 'completed') {
                    summary += ` - COMPLETED`;
                    if (booking.price) {
                        summary += ` (£${booking.price})`;
                    }
                }
                
                const event = {
                    summary: summary,
                    description: `
Customer: ${booking.customerName}
Phone: ${booking.customerPhone}
Pickup: ${booking.pickupAddress}
${booking.stops.length > 0 ? 'Stops: ' + booking.stops.join(', ') + '\n' : ''}Destination: ${booking.destinationAddress}
Status: ${booking.status.toUpperCase()}
${booking.price ? 'Price: £' + booking.price : ''}
${booking.notes ? 'Notes: ' + booking.notes : ''}
${booking.completionNotes ? 'Completion Notes: ' + booking.completionNotes : ''}
                    `.trim(),
                    start: {
                        dateTime: startDateTime.toISOString(),
                        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    },
                    end: {
                        dateTime: endDateTime.toISOString(),
                        timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    },
                    location: booking.pickupAddress
                };
                
                await gapi.client.calendar.events.update({
                    calendarId: calendarId,
                    eventId: booking.calendarEventId,
                    resource: event
                });
                
            } catch (error) {
                console.error('Error updating calendar event:', error);
            }
        }

        async function deleteCalendarEvent(booking) {
            if (!booking.calendarEventId || !isCalendarConnected) return;
            
            try {
                await gapi.client.calendar.events.delete({
                    calendarId: calendarId,
                    eventId: booking.calendarEventId
                });
                
                booking.calendarEventId = null;
                
            } catch (error) {
                console.error('Error deleting calendar event:', error);
            }
        }

        // Load bookings data from local storage
        function loadLocalData() {
            const stored = localStorage.getItem('taxiBookings');
            if (stored) {
                try {
                    bookings = JSON.parse(stored);
                } catch (error) {
                    console.error('Error loading data:', error);
                    bookings = [];
                }
            }
        }

        // Save bookings data to local storage
        function saveLocalData() {
            localStorage.setItem('taxiBookings', JSON.stringify(bookings));
            localStorage.setItem('taxiBookingsLastModified', Date.now().toString());
        }

        // Update the sync status message displayed to the user
        function updateSyncStatus(type, message) {
            const statusEl = document.getElementById('sync-status');
            statusEl.textContent = message;
            statusEl.className = `sync-status ${type}`;
        }

        // Clear all form fields for new booking
        function clearForm() {
            document.getElementById('customer-name').value = '';
            document.getElementById('customer-phone').value = '';
            document.getElementById('pickup-address').value = '';
            document.getElementById('destination-address').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('reminder-minutes').value = '5';
            document.getElementById('recurring-booking').checked = false;
            document.getElementById('recurring-end-date').value = '';
            document.getElementById('sync-to-calendar').checked = true;
            
            const now = new Date();
            document.getElementById('booking-date').value = now.toISOString().split('T')[0];
            document.getElementById('booking-time').value = now.toTimeString().slice(0, 5);
            
            document.querySelectorAll('.day-checkbox').forEach(day => {
                day.classList.remove('selected');
                day.querySelector('input').checked = false;
            });
            
            toggleRecurring();
            clearStops();
            
            document.getElementById('booking-form').removeAttribute('data-editing-id');
            const submitBtn = document.querySelector('#booking-form button[type="submit"]');
            submitBtn.textContent = 'Create Booking';
            submitBtn.style.background = '#007bff';
            
            updateSyncStatus('info', 'Form cleared');
        }

        // Add a new stop to the booking form
        function addStop() {
            stopCounter++;
            const container = document.getElementById('stops-container');
            const stopDiv = document.createElement('div');
            stopDiv.className = 'stop-item';
            stopDiv.innerHTML = `
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="min-width: 60px; font-weight: bold;">Stop ${stopCounter}:</span>
                    <input type="text" placeholder="Enter stop address" class="stop-address" style="flex: 1;">
                    <button type="button" onclick="removeStop(this)" class="btn-small btn-delete" style="width: auto;">Remove</button>
                </div>
            `;
            container.appendChild(stopDiv);
        }

        // Remove a stop from the booking form
        function removeStop(button) {
            button.closest('.stop-item').remove();
        }

        // Toggle the visibility of recurring booking options
        function toggleRecurring() {
            const checkbox = document.getElementById('recurring-booking');
            const options = document.getElementById('recurring-options');
            options.style.display = checkbox.checked ? 'block' : 'none';
        }

        // Toggle the selection of a day in the recurring booking options
        function toggleDay(element, dayValue) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            element.classList.toggle('selected', checkbox.checked);
        }

        // Get the addresses of all additional stops
        function getStops() {
            const stopInputs = document.querySelectorAll('.stop-address');
            const stops = [];
            stopInputs.forEach(input => {
                if (input.value.trim()) {
                    stops.push(input.value.trim());
                }
            });
            return stops;
        }

        // Clear all additional stops
        function clearStops() {
            document.getElementById('stops-container').innerHTML = '';
            stopCounter = 0;
        }

        // Get the selected days for recurring bookings
        function getSelectedDays() {
            const selectedDays = [];
            document.querySelectorAll('.day-checkbox input[type="checkbox"]:checked').forEach(checkbox => {
                selectedDays.push(parseInt(checkbox.value));
            });
            return selectedDays;
        }

        // Generate recurring bookings based on selected days and end date
        function generateRecurringBookings(baseBooking) {
            const bookings = [];
            const selectedDays = getSelectedDays();
            const endDateString = document.getElementById('recurring-end-date').value;
            
            if (selectedDays.length === 0) {
                alert('Please select at least one day for recurring booking');
                return [];
            }
            
            if (!endDateString) {
                alert('Please select an end date for recurring booking');
                return [];
            }
            
            const startDateString = baseBooking.date;
            let bookingId = baseBooking.id;
            const endDateObj = new Date(endDateString + 'T00:00:00');
            
            let currentDateObj = new Date(startDateString + 'T00:00:00');
            while (currentDateObj <= endDateObj) {
                const dayOfWeek = currentDateObj.getDay();
                const currentDateString = currentDateObj.toISOString().split('T')[0];
                
                if (selectedDays.includes(dayOfWeek)) {
                    const booking = {
                        ...baseBooking,
                        id: bookingId++,
                        date: currentDateString,
                        isRecurring: true,
                        recurringGroup: baseBooking.id,
                        recurringDays: selectedDays
                    };
                    bookings.push(booking);
                }
                
                currentDateObj.setDate(currentDateObj.getDate() + 1);
            }
            
            return bookings;
        }

        // Handle the form submission for creating or updating bookings
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const stops = getStops();
            const isRecurring = document.getElementById('recurring-booking').checked;
            const syncToCalendar = document.getElementById('sync-to-calendar').checked;
            const editingId = document.getElementById('booking-form').dataset.editingId;
            
            if (editingId) {
                // Update existing booking
                const booking = bookings.find(b => b.id == editingId);
                if (booking) {
                    booking.customerName = document.getElementById('customer-name').value;
                    booking.customerPhone = document.getElementById('customer-phone').value;
                    booking.pickupAddress = document.getElementById('pickup-address').value;
                    booking.stops = stops;
                    booking.destinationAddress = document.getElementById('destination-address').value;
                    booking.date = document.getElementById('booking-date').value;
                    booking.time = document.getElementById('booking-time').value;
                    booking.notes = document.getElementById('notes').value;
                    booking.reminderMinutes = parseInt(document.getElementById('reminder-minutes').value);
                    
                    if (!booking.timeline) booking.timeline = [];
                    booking.timeline.push({
                        status: 'updated',
                        timestamp: new Date().toISOString(),
                        note: 'Booking details updated'
                    });
                    
                    // Update calendar event if connected and syncing is enabled
                    if (isCalendarConnected && syncToCalendar && booking.calendarEventId) {
                        await updateCalendarEvent(booking);
                    }
                    
                    saveLocalData();
                    displayBookings();
                    updateStats();
                    
                    document.getElementById('booking-form').removeAttribute('data-editing-id');
                    const submitBtn = document.querySelector('#booking-form button[type="submit"]');
                    submitBtn.textContent = 'Create Booking';
                    submitBtn.style.background = '#007bff';
                    
                    updateSyncStatus('success', 'Booking updated successfully');
                }
            } else {
                // Create new booking
                const baseBooking = {
                    id: Date.now(),
                    customerName: document.getElementById('customer-name').value,
                    customerPhone: document.getElementById('customer-phone').value,
                    pickupAddress: document.getElementById('pickup-address').value,
                    stops: stops,
                    destinationAddress: document.getElementById('destination-address').value,
                    date: document.getElementById('booking-date').value,
                    time: document.getElementById('booking-time').value,
                    notes: document.getElementById('notes').value,
                    reminderMinutes: parseInt(document.getElementById('reminder-minutes').value),
                    reminderShown: false,
                    status: 'active',
                    price: null,
                    calendarEventId: null,
                    timeline: [{
                        status: 'active',
                        timestamp: new Date().toISOString(),
                        note: 'Booking created'
                    }],
                    created: new Date().toISOString()
                };
                
                let newBookings = [];
                if (isRecurring) {
                    newBookings = generateRecurringBookings(baseBooking);
                    if (newBookings.length === 0) return;
                    updateSyncStatus('success', `Created ${newBookings.length} recurring bookings`);
                } else {
                    newBookings = [baseBooking];
                    updateSyncStatus('success', 'Booking created successfully');
                }
                
                bookings.push(...newBookings);
                
                // Create calendar events if connected and syncing is enabled
                if (isCalendarConnected && syncToCalendar) {
                    for (const booking of newBookings) {
                        const eventId = await createCalendarEvent(booking);
                        if (eventId) {
                            booking.calendarEventId = eventId;
                        }
                    }
                }
                
                saveLocalData();
                displayBookings();
                updateStats();
            }
            
            // Clear form fields
            clearForm();
        }

        // Update the status of a booking
        async function updateBookingStatus(id, newStatus, note = '') {
            const booking = bookings.find(b => b.id === id);
            if (!booking) return;
            
            booking.status = newStatus;
            
            if (!booking.timeline) booking.timeline = [];
            booking.timeline.push({
                status: newStatus,
                timestamp: new Date().toISOString(),
                note: note || `Status changed to ${newStatus}`
            });
            
            // Update calendar event if connected
            if (isCalendarConnected && booking.calendarEventId) {
                await updateCalendarEvent(booking);
            }
            
            saveLocalData();
            displayBookings();
            updateStats();
            
            const statusMessages = {
                'en-route': 'Driver en route to pickup',
                'waiting': 'Driver waiting at pickup location',
                'pob': 'Passenger on board - journey started',
                'completed': 'Journey completed'
            };
            
            updateSyncStatus('success', statusMessages[newStatus] || `Status updated to ${newStatus}`);
        }

        // Complete a booking and show completion form
        function completeBooking(id) {
            const booking = bookings.find(b => b.id === id);
            if (!booking) return;
            
            const formId = `completion-form-${id}`;
            const existingForm = document.getElementById(formId);
            if (existingForm) {
                existingForm.classList.toggle('show');
                return;
            }
            
            const bookingElement = document.querySelector(`[data-booking-id="${id}"]`);
            const completionForm = document.createElement('div');
            completionForm.id = formId;
            completionForm.className = 'completion-form show';
            completionForm.innerHTML = `
                <h4>Complete Booking</h4>
                <div style="margin-bottom: 10px;">
                    <label>Price: £</label>
                    <input type="number" id="price-${id}" class="price-input" step="0.01" min="0" placeholder="0.00" required>
                    <button onclick="finalizeCompletion(${id})" class="btn-small btn-complete">Complete</button>
                    <button onclick="cancelCompletion(${id})" class="btn-small btn-delete">Cancel</button>
                </div>
                <div>
                    <label>Completion Notes (optional):</label>
                    <textarea id="completion-notes-${id}" rows="2" placeholder="Any additional notes..."></textarea>
                </div>
            `;
            
            bookingElement.appendChild(completionForm);
            document.getElementById(`price-${id}`).focus();
        }

        // Finalize the completion of a booking
        async function finalizeCompletion(id) {
            const priceInput = document.getElementById(`price-${id}`);
            const notesInput = document.getElementById(`completion-notes-${id}`);
            const price = parseFloat(priceInput.value);
            
            if (isNaN(price) || price < 0) {
                alert('Please enter a valid price');
                return;
            }
            
            const booking = bookings.find(b => b.id === id);
            if (booking) {
                booking.status = 'completed';
                booking.price = price;
                booking.completedAt = new Date().toISOString();
                booking.completionNotes = notesInput.value;
                
                if (!booking.timeline) booking.timeline = [];
                booking.timeline.push({
                    status: 'completed',
                    timestamp: new Date().toISOString(),
                    note: `Journey completed - £${price.toFixed(2)}${notesInput.value ? ' - ' + notesInput.value : ''}`
                });
                
                // Update calendar event if connected
                if (isCalendarConnected && booking.calendarEventId) {
                    await updateCalendarEvent(booking);
                }
                
                saveLocalData();
                displayBookings();
                updateStats();
                
                updateSyncStatus('success', `Job completed - £${price.toFixed(2)} earned`);
            }
        }

        // Cancel the completion form
        function cancelCompletion(id) {
            const form = document.getElementById(`completion-form-${id}`);
            if (form) {
                form.remove();
            }
        }

        // Edit an existing booking
        function editBooking(id) {
            const booking = bookings.find(b => b.id === id);
            if (!booking) return;
            
            // Fill form with booking data
            document.getElementById('customer-name').value = booking.customerName;
            document.getElementById('customer-phone').value = booking.customerPhone;
            document.getElementById('pickup-address').value = booking.pickupAddress;
            document.getElementById('destination-address').value = booking.destinationAddress;
            document.getElementById('booking-date').value = booking.date;
            document.getElementById('booking-time').value = booking.time;
            document.getElementById('notes').value = booking.notes || '';
            document.getElementById('reminder-minutes').value = booking.reminderMinutes || 5;
            
            // Clear existing stops and add booking stops
            clearStops();
            if (booking.stops && booking.stops.length > 0) {
                booking.stops.forEach(stop => {
                    addStop();
                    const stopInputs = document.querySelectorAll('.stop-address');
                    const lastInput = stopInputs[stopInputs.length - 1];
                    lastInput.value = stop;
                });
            }
            
            // Set form to edit mode
            document.getElementById('booking-form').dataset.editingId = id;
            const submitBtn = document.querySelector('#booking-form button[type="submit"]');
            submitBtn.textContent = 'Update Booking';
            submitBtn.style.background = '#fd7e14';
            
            updateSyncStatus('info', 'Editing booking - make changes and click Update');
        }

        // Delete a booking
        async function deleteBooking(id) {
            if (!confirm('Are you sure you want to delete this booking?')) return;
            
            const booking = bookings.find(b => b.id === id);
            
            // Delete from calendar if connected
            if (booking && isCalendarConnected && booking.calendarEventId) {
                await deleteCalendarEvent(booking);
            }
            
            bookings = bookings.filter(b => b.id !== id);
            saveLocalData();
            displayBookings();
            updateStats();
            
            updateSyncStatus('success', 'Booking deleted successfully');
        }

        // Display all bookings in the right panel
        function displayBookings() {
            const container = document.getElementById('bookings-list');
            const filteredBookings = getFilteredBookings();
            
            if (filteredBookings.length === 0) {
                container.innerHTML = '<p>No bookings match the current filter.</p>';
                document.getElementById('booking-count').textContent = '0';
                return;
            }
            
            // Sort bookings by date and time
            filteredBookings.sort((a, b) => {
                const dateTimeA = new Date(`${a.date}T${a.time}`);
                const dateTimeB = new Date(`${b.date}T${b.time}`);
                return dateTimeA - dateTimeB;
            });
            
            const now = new Date();
            const currentTimeString = now.toTimeString().slice(0, 5);
            const currentDateString = now.toISOString().split('T')[0];
            
            container.innerHTML = filteredBookings.map(booking => {
                const bookingDateTime = new Date(`${booking.date}T${booking.time}`);
                const isToday = booking.date === currentDateString;
                const isPast = bookingDateTime < now;
                const isCurrentTime = isToday && Math.abs(bookingDateTime - now) < 15 * 60 * 1000; // Within 15 minutes
                
                const statusClass = booking.status;
                const currentTimeClass = isCurrentTime ? 'current-time' : '';
                
                // Format timeline
                const timelineHtml = booking.timeline ? booking.timeline
                    .slice(-3) // Show last 3 entries
                    .map(entry => {
                        const time = new Date(entry.timestamp).toLocaleString();
                        return `<div class="timeline-item">${time}: ${entry.note}</div>`;
                    }).join('') : '';
                
                return `
                    <div class="booking-item ${statusClass} ${currentTimeClass}" data-booking-id="${booking.id}">
                        <div class="status-badge status-${statusClass}">${booking.status}</div>
                        
                        <div class="booking-header">
                            ${booking.customerName} - ${booking.date} at ${booking.time}
                            ${booking.calendarEventId ? '📅' : ''}
                        </div>
                        
                        <div class="booking-details">
                            <strong>Phone:</strong> ${booking.customerPhone}<br>
                            <strong>Pickup:</strong> ${booking.pickupAddress}<br>
                            ${booking.stops && booking.stops.length > 0 ? 
                                `<strong>Stops:</strong> ${booking.stops.join(', ')}<br>` : ''}
                            <strong>Destination:</strong> ${booking.destinationAddress}<br>
                            ${booking.notes ? `<strong>Notes:</strong> ${booking.notes}<br>` : ''}
                            ${booking.price ? `<strong>Price:</strong> £${booking.price}<br>` : ''}
                            ${booking.completionNotes ? `<strong>Completion Notes:</strong> ${booking.completionNotes}<br>` : ''}
                            ${booking.reminderMinutes > 0 ? `<strong>Reminder:</strong> ${booking.reminderMinutes} minutes before<br>` : ''}
                            ${booking.isRecurring ? '<strong>Recurring:</strong> Yes<br>' : ''}
                        </div>
                        
                        ${timelineHtml ? `<div class="timeline">${timelineHtml}</div>` : ''}
                        
                        <div class="booking-actions">
                            ${booking.status === 'active' ? `
                                <button class="btn-small btn-en-route" onclick="updateBookingStatus(${booking.id}, 'en-route')">En Route</button>
                                <button class="btn-small btn-waiting" onclick="updateBookingStatus(${booking.id}, 'waiting')">Waiting</button>
                                <button class="btn-small btn-pob" onclick="updateBookingStatus(${booking.id}, 'pob')">POB</button>
                            ` : ''}
                            
                            ${booking.status === 'en-route' ? `
                                <button class="btn-small btn-waiting" onclick="updateBookingStatus(${booking.id}, 'waiting')">Waiting</button>
                                <button class="btn-small btn-pob" onclick="updateBookingStatus(${booking.id}, 'pob')">POB</button>
                                <button class="btn-small btn-active" onclick="updateBookingStatus(${booking.id}, 'active')">Reset</button>
                            ` : ''}
                            
                            ${booking.status === 'waiting' ? `
                                <button class="btn-small btn-pob" onclick="updateBookingStatus(${booking.id}, 'pob')">POB</button>
                                <button class="btn-small btn-en-route" onclick="updateBookingStatus(${booking.id}, 'en-route')">En Route</button>
                                <button class="btn-small btn-active" onclick="updateBookingStatus(${booking.id}, 'active')">Reset</button>
                            ` : ''}
                            
                            ${booking.status === 'pob' ? `
                                <button class="btn-small btn-complete" onclick="completeBooking(${booking.id})">Complete</button>
                                <button class="btn-small btn-waiting" onclick="updateBookingStatus(${booking.id}, 'waiting')">Waiting</button>
                                <button class="btn-small btn-active" onclick="updateBookingStatus(${booking.id}, 'active')">Reset</button>
                            ` : ''}
                            
                            ${booking.status !== 'completed' ? `
                                <button class="btn-small btn-edit" onclick="editBooking(${booking.id})">Edit</button>
                            ` : ''}
                            
                            <button class="btn-small btn-delete" onclick="deleteBooking(${booking.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('booking-count').textContent = filteredBookings.length;
            updateCurrentTimeIndicators();
        }

        // Get filtered bookings based on current filter and search term
        function getFilteredBookings() {
            let filtered = bookings;
            
            // Apply search filter
            if (currentSearchTerm) {
                const searchLower = currentSearchTerm.toLowerCase();
                filtered = filtered.filter(booking => 
                    booking.customerName.toLowerCase().includes(searchLower) ||
                    booking.customerPhone.includes(searchLower) ||
                    booking.pickupAddress.toLowerCase().includes(searchLower) ||
                    booking.destinationAddress.toLowerCase().includes(searchLower) ||
                    (booking.stops && booking.stops.some(stop => stop.toLowerCase().includes(searchLower)))
                );
            }
            
            // Apply status filter
            const today = new Date().toISOString().split('T')[0];
            
            switch (currentFilter) {
                case 'active':
                    return filtered.filter(b => b.status !== 'completed');
                case 'completed':
                    return filtered.filter(b => b.status === 'completed');
                case 'today':
                    return filtered.filter(b => b.date === today);
                case 'all':
                default:
                    return filtered;
            }
        }

        // Set the current filter for displaying bookings
        function setFilter(filter) {
            currentFilter = filter;
            
            // Update filter button states
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            displayBookings();
        }

        // Search bookings based on user input
        function searchBookings() {
            currentSearchTerm = document.getElementById('booking-search').value;
            displayBookings();
        }

        // Update statistics displayed on the UI
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            
            const totalBookings = bookings.length;
            const activeBookings = bookings.filter(b => b.status !== 'completed').length;
            const completedToday = bookings.filter(b => 
                b.status === 'completed' && 
                b.completedAt && 
                b.completedAt.startsWith(today)
            ).length;
            
            const todayEarnings = bookings
                .filter(b => 
                    b.status === 'completed' && 
                    b.completedAt && 
                    b.completedAt.startsWith(today) && 
                    b.price
                )
                .reduce((sum, b) => sum + b.price, 0);
            
            document.getElementById('total-bookings').textContent = totalBookings;
            document.getElementById('active-bookings').textContent = activeBookings;
            document.getElementById('completed-today').textContent = completedToday;
            document.getElementById('today-earnings').textContent = `£${todayEarnings.toFixed(2)}`;
        }

        // Update current time indicators in the booking list
        function updateCurrentTimeIndicators() {
            const now = new Date();
            const currentTimeString = now.toTimeString().slice(0, 5);
            const currentDateString = now.toISOString().split('T')[0];
            
            document.querySelectorAll('.booking-item').forEach(item => {
                const bookingId = item.dataset.bookingId;
                const booking = bookings.find(b => b.id == bookingId);
                
                if (booking) {
                    const bookingDateTime = new Date(`${booking.date}T${booking.time}`);
                    const isToday = booking.date === currentDateString;
                    const isCurrentTime = isToday && Math.abs(bookingDateTime - now) < 15 * 60 * 1000;
                    
                    item.classList.toggle('current-time', isCurrentTime);
                }
            });
        }

        // Cancel the completion form
        function cancelCompletion(id) {
            const form = document.getElementById(`completion-form-${id}`);
            if (form) {
                form.remove();
            }
        }

        // Scroll to current time in the booking list
        function scrollToCurrentTime() {
            const currentTimeElement = document.querySelector('.booking-item.current-time');
            if (currentTimeElement) {
                currentTimeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                currentTimeElement.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => {
                    currentTimeElement.style.animation = '';
                }, 500);
            } else {
                updateSyncStatus('info', 'No bookings near current time');
            }
        }

        // Scroll to the next upcoming booking
        function scrollToNextBooking() {
            const now = new Date();
            const upcomingBookings = bookings
                .filter(b => b.status !== 'completed')
                .filter(b => {
                    const bookingDateTime = new Date(`${b.date}T${b.time}`);
                    return bookingDateTime > now;
                })
                .sort((a, b) => {
                    const dateTimeA = new Date(`${a.date}T${a.time}`);
                    const dateTimeB = new Date(`${b.date}T${b.time}`);
                    return dateTimeA - dateTimeB;
                });

            if (upcomingBookings.length > 0) {
                const nextBooking = upcomingBookings[0];
                const nextElement = document.querySelector(`[data-booking-id="${nextBooking.id}"]`);
                if (nextElement) {
                    nextElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    nextElement.style.animation = 'shake 0.5s ease-in-out';
                    setTimeout(() => {
                        nextElement.style.animation = '';
                    }, 500);
                }
            } else {
                updateSyncStatus('info', 'No upcoming bookings found');
            }
        }

        // Export booking data to JSON file
        function exportData() {
            const dataStr = JSON.stringify(bookings, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `taxi-bookings-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            updateSyncStatus('success', 'Data exported successfully');
        }

        // Import booking data from JSON file
        function importData() {
            document.getElementById('import-file').click();
        }

        // Handle file import
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        if (confirm(`Import ${importedData.length} bookings? This will replace all current data.`)) {
                            bookings = importedData;
                            saveLocalData();
                            displayBookings();
                            updateStats();
                            updateSyncStatus('success', `Imported ${importedData.length} bookings successfully`);
                        }
                    } else {
                        alert('Invalid file format. Please select a valid booking data file.');
                    }
                } catch (error) {
                    alert('Error reading file. Please ensure it\'s a valid JSON file.');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        // Handle keyboard shortcuts
        function handleKeyboardShortcuts(e) {
            // Only trigger shortcuts when not typing in input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch (e.key.toLowerCase()) {
                case 'n':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        document.getElementById('customer-name').focus();
                    }
                    break;
                case 'c':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        clearForm();
                    }
                    break;
                case 'f':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        document.getElementById('booking-search').focus();
                    }
                    break;
                case 't':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        scrollToCurrentTime();
                    }
                    break;
                case 'j':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        scrollToNextBooking();
                    }
                    break;
                case '1':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        setFilter('active');
                    }
                    break;
                case '2':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        setFilter('all');
                    }
                    break;
                case '3':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        setFilter('completed');
                    }
                    break;
                case '4':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        setFilter('today');
                    }
                    break;
            }
        }

        // Show keyboard shortcuts modal
        function showKeyboardShortcuts() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
                    <h3 style="margin-bottom: 20px;">Keyboard Shortcuts</h3>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px; font-family: monospace;">
                        <strong>Ctrl+N</strong><span>New booking (focus name field)</span>
                        <strong>Ctrl+C</strong><span>Clear form</span>
                        <strong>Ctrl+F</strong><span>Focus search</span>
                        <strong>Ctrl+T</strong><span>Go to current time</span>
                        <strong>Ctrl+J</strong><span>Go to next job</span>
                        <strong>Ctrl+1</strong><span>Show active bookings</span>
                        <strong>Ctrl+2</strong><span>Show all bookings</span>
                        <strong>Ctrl+3</strong><span>Show completed bookings</span>
                        <strong>Ctrl+4</strong><span>Show today's bookings</span>
                    </div>
                    <button onclick="this.closest('div').parentElement.remove()" 
                            style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Close
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close on click outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Request notification permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        updateSyncStatus('success', 'Notifications enabled for reminders');
                    }
                });
            }
        }

        // Initialize audio context for reminder sounds
        function initializeAudio() {
            if (!audioInitialized) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    audioInitialized = true;
                    console.log('Audio context initialized');
                } catch (error) {
                    console.error('Audio initialization failed:', error);
                }
            }
        }

        // Play reminder sound
        function playReminderSound() {
            if (!audioContext) return;
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.error('Error playing reminder sound:', error);
            }
        }

        // Check for booking reminders
        function checkReminders() {
            const now = new Date();
            
            bookings.forEach(booking => {
                if (booking.status === 'completed' || booking.reminderShown || booking.reminderMinutes === 0) {
                    return;
                }
                
                const bookingDateTime = new Date(`${booking.date}T${booking.time}`);
                const reminderTime = new Date(bookingDateTime.getTime() - (booking.reminderMinutes * 60 * 1000));
                
                if (now >= reminderTime && now < bookingDateTime) {
                    showReminder(booking);
                    booking.reminderShown = true;
                    saveLocalData();
                }
            });
        }

        // Show reminder notification
        function showReminder(booking) {
            const title = 'Taxi Booking Reminder';
            const message = `Pickup in ${booking.reminderMinutes} minutes: ${booking.customerName} at ${booking.pickupAddress}`;
            
            // Play sound
            playReminderSound();
            
            // Show browser notification
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: message,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🚕</text></svg>',
                    requireInteraction: true
                });
                
                notification.onclick = () => {
                    window.focus();
                    const bookingElement = document.querySelector(`[data-booking-id="${booking.id}"]`);
                    if (bookingElement) {
                        bookingElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        bookingElement.style.animation = 'shake 0.5s ease-in-out';
                        setTimeout(() => {
                            bookingElement.style.animation = '';
                        }, 500);
                    }
                    notification.close();
                };
                
                // Auto-close after 10 seconds
                setTimeout(() => {
                    notification.close();
                }, 10000);
            }
            
            // Show visual reminder in the app
            updateSyncStatus('warning', message);
            
            // Add to timeline
            if (!booking.timeline) booking.timeline = [];
            booking.timeline.push({
                status: 'reminder',
                timestamp: new Date().toISOString(),
                note: `Reminder shown: ${booking.reminderMinutes} minutes before pickup`
            });
        }

        // Test reminder system
        function testReminder() {
            const testBooking = {
                id: 'test',
                customerName: 'Test Customer',
                pickupAddress: 'Test Address',
                reminderMinutes: 5
            };
            
            showReminder(testBooking);
            updateSyncStatus('info', 'Test reminder triggered - check notifications and sound');
        }

        // Calendar integration functions

        // Initialize Google Calendar API
        function initializeCalendar() {
            // This would be implemented with Google Calendar API
            // For now, we'll simulate calendar integration
            console.log('Calendar integration would be initialized here');
        }

        // Add booking to calendar
        async function addToCalendar(booking) {
            if (!isCalendarConnected) {
                updateSyncStatus('warning', 'Calendar not connected');
                return;
            }
            
            try {
                // Simulate calendar event creation
                const eventId = `taxi_${booking.id}_${Date.now()}`;
                booking.calendarEventId = eventId;
                
                saveLocalData();
                displayBookings();
                
                updateSyncStatus('success', 'Booking added to calendar');
            } catch (error) {
                console.error('Calendar error:', error);
                updateSyncStatus('error', 'Failed to add to calendar');
            }
        }

        // Update calendar event
        async function updateCalendarEvent(booking) {
            if (!isCalendarConnected || !booking.calendarEventId) return;
            
            try {
                // Simulate calendar event update
                updateSyncStatus('success', 'Calendar event updated');
            } catch (error) {
                console.error('Calendar update error:', error);
                updateSyncStatus('error', 'Failed to update calendar');
            }
        }

        // Delete calendar event
        async function deleteCalendarEvent(booking) {
            if (!isCalendarConnected || !booking.calendarEventId) return;
            
            try {
                // Simulate calendar event deletion
                booking.calendarEventId = null;
                updateSyncStatus('success', 'Calendar event deleted');
            } catch (error) {
                console.error('Calendar delete error:', error);
                updateSyncStatus('error', 'Failed to delete calendar event');
            }
        }

        // Backup and sync functions
        function createBackup() {
            const backup = {
                bookings: bookings,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `taxi-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            updateSyncStatus('success', 'Backup created successfully');
        }

        // Auto-save functionality
        function enableAutoSave() {
            // Save data every 30 seconds
            setInterval(() => {
                saveLocalData();
            }, 30000);
        }

        // Data validation
        function validateBookingData(booking) {
            const required = ['customerName', 'customerPhone', 'pickupAddress', 'destinationAddress', 'date', 'time'];
            const missing = required.filter(field => !booking[field] || booking[field].trim() === '');
            
            if (missing.length > 0) {
                throw new Error(`Missing required fields: ${missing.join(', ')}`);
            }
            
            // Validate phone number
            const phoneRegex = /^[0-9\s\-\+\(\)]{10,15}$/;
            if (!phoneRegex.test(booking.customerPhone)) {
                throw new Error('Invalid phone number format');
            }
            
            // Validate date and time
            const bookingDateTime = new Date(`${booking.date}T${booking.time}`);
            if (isNaN(bookingDateTime.getTime())) {
                throw new Error('Invalid date or time');
            }
            
            return true;
        }

        // Performance monitoring
        function logPerformance(action, startTime) {
            const endTime = performance.now();
            const duration = endTime - startTime;
            console.log(`${action} took ${duration.toFixed(2)}ms`);
            
            if (duration > 100) {
                console.warn(`Slow operation detected: ${action}`);
            }
        }

        // Error handling and logging
        function handleError(error, context) {
            console.error(`Error in ${context}:`, error);
            updateSyncStatus('error', `Error: ${error.message}`);
            
            // Log error for debugging
            const errorLog = {
                timestamp: new Date().toISOString(),
                context: context,
                error: error.message,
                stack: error.stack
            };
            
            // Store error logs in localStorage for debugging
            const errorLogs = JSON.parse(localStorage.getItem('taxiErrorLogs') || '[]');
            errorLogs.push(errorLog);
            
            // Keep only last 50 error logs
            if (errorLogs.length > 50) {
                errorLogs.splice(0, errorLogs.length - 50);
            }
            
            localStorage.setItem('taxiErrorLogs', JSON.stringify(errorLogs));
        }

        // Initialize auto-save when the app loads
        document.addEventListener('DOMContentLoaded', function() {
            enableAutoSave();
        });

        // Service worker registration for offline functionality
        if ('serviceWorker' in navigator && (location.protocol === 'https:' || location.protocol === 'http:')) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        } else if (location.protocol === 'file:') {
            console.log('ServiceWorker not available for file:// protocol - running in local mode');
        }

        // Handle online/offline status
        window.addEventListener('online', function() {
            updateSyncStatus('success', 'Back online - data syncing available');
        });

        window.addEventListener('offline', function() {
            updateSyncStatus('warning', 'Working offline - data saved locally');
        });

        // Cleanup function for when the page is unloaded
        window.addEventListener('beforeunload', function() {
            saveLocalData();
        });

        // Initialize the application when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const startTime = performance.now();
                
                // Set today's date and current time in the booking form
                const now = new Date();
                document.getElementById('booking-date').value = now.toISOString().split('T')[0];
                document.getElementById('booking-time').value = now.toTimeString().slice(0, 5);
                
                // Load local data from local storage
                loadLocalData();
                displayBookings();
                updateStats();
                
                // Setup form submission handler
                document.getElementById('booking-form').addEventListener('submit', handleFormSubmit);
                
                // Update current time indicators every minute
                setInterval(updateCurrentTimeIndicators, 60000);
                
                // Add keyboard shortcuts
                document.addEventListener('keydown', handleKeyboardShortcuts);
                
                // Request notification permission
                requestNotificationPermission();
                
                // Start reminder checking system
                setInterval(checkReminders, 30000);
                
                // Initialize audio on first user interaction
                document.addEventListener('click', initializeAudio, { once: true });
                document.addEventListener('keydown', initializeAudio, { once: true });
                
                logPerformance('Application initialization', startTime);
                
            } catch (error) {
                handleError(error, 'Application initialization');
            }
        });
    </script>
</body>
</html>
